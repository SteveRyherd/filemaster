{% extends 'admin/master.html' %}

{% block body %}
<div class="admin-header">
    <h2>Request {{ req.token }}</h2>
    <div class="request-meta">
        {% if req.expires_at %}
            <span class="expiration">Expires {{ req.expires_at.strftime('%Y-%m-%d %H:%M UTC') }}</span>
        {% else %}
            <span class="no-expiration">No expiration</span>
        {% endif %}
        <a href="{{ url_for('clientrequest.index_view') }}" class="back-link">‚Üê Back to All Requests</a>
    </div>
</div>

<div class="layout">
    <div class="queue">
        <h3>Submitted Items</h3>
        <ul class="module-list">
        {% for m in req.modules %}
            <li class="module-item {{ 'completed' if m.completed else 'incomplete' }}" 
                data-module-id="{{ m.id }}">
                <span class="status-icon">
                    {% if m.completed %}&#10003;{% else %}&#9633;{% endif %}
                </span>
                <a href="?module={{ m.id }}" class="module-link">
                    {{ m.description }}
                </a>
                <span class="module-type">{{ m.kind }}</span>
            </li>
        {% endfor %}
        </ul>
        
        <div class="request-summary">
            <strong>Progress:</strong> 
            {{ req.modules|selectattr('completed')|list|length }} / {{ req.modules|length }} complete
        </div>
    </div>
    
    <div class="module">
        {% if selected %}
            <div class="module-content">
                <h3>{{ selected.description }}</h3>
                <div class="module-type-badge">{{ selected.kind|title }}</div>
                
                {% if selected.completed and selected.result_data %}
                    {% if selected.kind == 'file' %}
                        <div class="file-preview">
                            {% set file_path = selected.result_data['file_path'] %}
                            {% set original_name = selected.result_data['original_filename'] %}
                            
                            {% if file_path.lower().endswith(('png','jpg','jpeg','gif','heic')) %}
                                <div class="image-preview">
                                    <img src="{{ url_for('uploaded_file', filename=file_path) }}" 
                                         alt="{{ original_name }}" class="preview-image">
                                </div>
                            {% elif file_path.lower().endswith('pdf') %}
                                <div class="pdf-preview">
                                    <div class="pdf-icon">üìÑ</div>
                                    <p>PDF Document</p>
                                </div>
                            {% else %}
                                <div class="file-icon">üìÑ</div>
                            {% endif %}
                            
                            <div class="file-info">
                                <strong>Filename:</strong> {{ original_name }}<br>
                                {% if selected.result_data.get('file_size') %}
                                    <strong>Size:</strong> {{ (selected.result_data['file_size'] / 1024) | round(1) }} KB<br>
                                {% endif %}
                                <a href="{{ url_for('uploaded_file', filename=file_path) }}" 
                                   class="download-btn" download>
                                    ‚¨áÔ∏è Download File
                                </a>
                            </div>
                        </div>
                        
                    {% elif selected.kind in ['insurance_card', 'drivers_license'] %}
                        <div class="dual-file-preview">
                            {% if selected.result_data.get('front_file') %}
                                <div class="file-side">
                                    <h4>Front</h4>
                                    {% set front_path = selected.result_data['front_file']['file_path'] %}
                                    {% if front_path.lower().endswith(('png','jpg','jpeg','gif','heic')) %}
                                        <img src="{{ url_for('uploaded_file', filename=front_path) }}" 
                                             alt="Front" class="preview-image">
                                    {% else %}
                                        <div class="file-icon">üìÑ</div>
                                    {% endif %}
                                    <div class="file-info">
                                        <strong>{{ selected.result_data['front_file']['original_filename'] }}</strong><br>
                                        <a href="{{ url_for('uploaded_file', filename=front_path) }}" 
                                           class="download-btn" download>
                                            ‚¨áÔ∏è Download Front
                                        </a>
                                    </div>
                                </div>
                            {% endif %}
                            
                            {% if selected.result_data.get('back_file') %}
                                <div class="file-side">
                                    <h4>Back</h4>
                                    {% set back_path = selected.result_data['back_file']['file_path'] %}
                                    {% if back_path.lower().endswith(('png','jpg','jpeg','gif','heic')) %}
                                        <img src="{{ url_for('uploaded_file', filename=back_path) }}" 
                                             alt="Back" class="preview-image">
                                    {% else %}
                                        <div class="file-icon">üìÑ</div>
                                    {% endif %}
                                    <div class="file-info">
                                        <strong>{{ selected.result_data['back_file']['original_filename'] }}</strong><br>
                                        <a href="{{ url_for('uploaded_file', filename=back_path) }}" 
                                           class="download-btn" download>
                                            ‚¨áÔ∏è Download Back
                                        </a>
                                    </div>
                                </div>
                            {% endif %}
                        </div>
                        
                        {% if selected.result_data.get('notes') %}
                            <div class="notes-section">
                                <h4>Additional Notes:</h4>
                                <div class="notes-content">{{ selected.result_data['notes'] }}</div>
                            </div>
                        {% endif %}
                        
                    {% elif selected.kind == 'form' %}
                        <div class="form-preview">
                            <h4>Response:</h4>
                            <div class="form-answer">
                                {{ selected.result_data['answer'] }}
                            </div>
                        </div>
                        
                    {% else %}
                        <div class="generic-data">
                            <h4>Data:</h4>
                            <pre class="json-data">{{ selected.result_data | tojson(indent=2) }}</pre>
                        </div>
                    {% endif %}
                    
                {% else %}
                    <div class="incomplete-module">
                        <div class="incomplete-icon">‚è≥</div>
                        <p>This item has not been completed yet.</p>
                    </div>
                {% endif %}
            </div>
        {% else %}
            <div class="no-selection">
                <div class="completion-icon">‚úÖ</div>
                <h3>All items completed!</h3>
                <p>Select an item from the left to view its details.</p>
            </div>
        {% endif %}
    </div>
</div>
{% endblock %}

{% block tail %}
<style>
body { font-family: Arial, sans-serif; }
.layout { display: flex; }
.queue { width: 40%; padding: 1em; border-right: 1px solid #ccc; }
.module { flex: 1; padding: 1em; }

.admin-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 1em;
    padding-bottom: 1em;
    border-bottom: 2px solid #eee;
}

.request-meta {
    display: flex;
    align-items: center;
    gap: 1em;
}

.expiration {
    background: #fff3cd;
    border: 1px solid #ffeaa7;
    padding: 0.25em 0.5em;
    border-radius: 3px;
    font-size: 0.9em;
}

.no-expiration {
    background: #d4edda;
    border: 1px solid #c3e6cb;
    padding: 0.25em 0.5em;
    border-radius: 3px;
    font-size: 0.9em;
}

.back-link {
    color: #007bff;
    text-decoration: none;
    font-weight: bold;
}

.back-link:hover {
    text-decoration: underline;
}

.module-list {
    list-style: none;
    padding: 0;
    margin: 0;
}

.module-item {
    margin-bottom: 0.5em;
    padding: 0.75em;
    border: 1px solid #ddd;
    border-radius: 4px;
    display: flex;
    align-items: center;
    gap: 0.5em;
}

.module-item.completed {
    background: #f8f9fa;
    border-color: #28a745;
}

.module-item.incomplete {
    background: #fff8e1;
    border-color: #ffc107;
}

.status-icon {
    font-weight: bold;
    font-size: 1.2em;
}

.module-item.completed .status-icon {
    color: #28a745;
}

.module-item.incomplete .status-icon {
    color: #ffc107;
}

.module-link {
    flex: 1;
    text-decoration: none;
    color: #333;
    font-weight: 500;
}

.module-link:hover {
    color: #007bff;
}

.module-type {
    font-size: 0.8em;
    background: #e9ecef;
    padding: 0.25em 0.5em;
    border-radius: 3px;
    color: #666;
}

.request-summary {
    margin-top: 1em;
    padding: 1em;
    background: #f8f9fa;
    border: 1px solid #dee2e6;
    border-radius: 4px;
    text-align: center;
}

.module-content h3 {
    margin-top: 0;
    color: #333;
}

.module-type-badge {
    display: inline-block;
    background: #007bff;
    color: white;
    padding: 0.25em 0.75em;
    border-radius: 15px;
    font-size: 0.8em;
    margin-bottom: 1em;
}

.preview-image {
    max-width: 100%;
    max-height: 400px;
    border: 1px solid #ddd;
    border-radius: 4px;
    margin-bottom: 1em;
}

.file-preview, .dual-file-preview {
    text-align: center;
}

.dual-file-preview {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 1em;
    margin-bottom: 1em;
}

.file-side {
    text-align: center;
}

.file-side h4 {
    margin-top: 0;
    color: #555;
}

.file-info {
    background: #f8f9fa;
    padding: 1em;
    border-radius: 4px;
    margin-top: 1em;
}

.download-btn {
    display: inline-block;
    background: #28a745;
    color: white;
    padding: 0.5em 1em;
    text-decoration: none;
    border-radius: 4px;
    font-weight: bold;
    margin-top: 0.5em;
}

.download-btn:hover {
    background: #218838;
    color: white;
}

.pdf-preview, .file-icon {
    text-align: center;
    padding: 2em;
    border: 2px dashed #ddd;
    border-radius: 4px;
    margin-bottom: 1em;
}

.pdf-icon {
    font-size: 4em;
    margin-bottom: 0.5em;
}

.notes-section {
    margin-top: 1.5em;
    padding: 1em;
    background: #f8f9fa;
    border-left: 4px solid #007bff;
}

.notes-content {
    background: white;
    padding: 1em;
    border-radius: 4px;
    margin-top: 0.5em;
    white-space: pre-wrap;
}

.form-preview {
    background: #f8f9fa;
    padding: 1.5em;
    border-radius: 4px;
}

.form-answer {
    background: white;
    padding: 1em;
    border-radius: 4px;
    border: 1px solid #ddd;
    white-space: pre-wrap;
    margin-top: 0.5em;
}

.incomplete-module, .no-selection {
    text-align: center;
    padding: 3em;
    color: #666;
}

.incomplete-icon, .completion-icon {
    font-size: 4em;
    margin-bottom: 0.5em;
}

.json-data {
    background: #f8f9fa;
    padding: 1em;
    border-radius: 4px;
    font-size: 0.9em;
    overflow-x: auto;
}

/* Mobile responsiveness */
@media (max-width: 768px) {
    .layout {
        flex-direction: column;
    }
    
    .queue {
        width: 100%;
        border-right: none;
        border-bottom: 1px solid #ccc;
    }
    
    .dual-file-preview {
        grid-template-columns: 1fr;
    }
    
    .admin-header {
        flex-direction: column;
        align-items: flex-start;
        gap: 0.5em;
    }
}
</style>

<script>
// Add active state to selected module
document.addEventListener('DOMContentLoaded', function() {
    const urlParams = new URLSearchParams(window.location.search);
    const moduleId = urlParams.get('module');
    
    if (moduleId) {
        const moduleItem = document.querySelector(`[data-module-id="${moduleId}"]`);
        if (moduleItem) {
            moduleItem.style.backgroundColor = '#e3f2fd';
            moduleItem.style.borderColor = '#2196f3';
        }
    }
});
</script>
{% endblock %}